{% extends "base.html" %}

{% block title %}Quản lý học sinh - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user-check"></i> Quản lý học sinh
        <span class="badge bg-danger">ADMIN</span>
    </h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại Dashboard
    </a>
</div>

<!-- Filter Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {{ 'active' if status_filter == 'pending' else '' }}" 
           href="{{ url_for('admin_students', status='pending') }}">
            <i class="fas fa-clock"></i> Chờ xác minh 
            <span class="badge bg-warning ms-1">{{ students | rejectattr('confirmed') | selectattr('status', 'equalto', 'pending') | list | length }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{ 'active' if status_filter == 'confirmed' else '' }}" 
           href="{{ url_for('admin_students', status='confirmed') }}">
            <i class="fas fa-check"></i> Đã xác minh 
            <span class="badge bg-success ms-1">{{ students | selectattr('confirmed') | list | length }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{ 'active' if status_filter == 'all' else '' }}" 
           href="{{ url_for('admin_students', status='all') }}">
            <i class="fas fa-list"></i> Tất cả 
            <span class="badge bg-info ms-1">{{ students | length }}</span>
        </a>
    </li>
</ul>

{% if students %}
    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-dark text-center">
                <div class="card-body">
                    <h3>{{ students | rejectattr('confirmed') | selectattr('status', 'equalto', 'pending') | list | length }}</h3>
                    <small>Chờ xác minh</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white text-center">
                <div class="card-body">
                    <h3>{{ students | selectattr('confirmed') | list | length }}</h3>
                    <small>Đã xác minh</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white text-center">
                <div class="card-body">
                    <h3>{{ students | selectattr('status', 'equalto', 'rejected') | list | length }}</h3>
                    <small>Đã từ chối</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white text-center">
                <div class="card-body">
                    <h3>{{ students | length }}</h3>
                    <small>Tổng số</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Table -->
    <div class="card">
        <div class="card-header">
            <h5>
                <i class="fas fa-graduation-cap"></i> 
                Danh sách học sinh
                {% if status_filter == 'pending' %}
                    (Chờ xác minh)
                {% elif status_filter == 'confirmed' %}
                    (Đã xác minh)
                {% else %}
                    (Tất cả)
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>STT</th>
                            <th>Tên học sinh</th>
                            <th>Người thêm</th>
                            <th>Ngày thêm</th>
                            <th>Trạng thái</th>
                            <th>Ghi chú</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                            {% set member = Member.query.get(student.added_by) %}
                            <tr class="{% if student.confirmed %}table-success{% elif student.status == 'rejected' %}table-danger{% endif %}">
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ student.name }}</strong>
                                    {% if student.confirmed %}
                                        <i class="fas fa-check-circle text-success ms-1" title="Đã xác minh"></i>
                                    {% elif student.status == 'rejected' %}
                                        <i class="fas fa-times-circle text-danger ms-1" title="Đã từ chối"></i>
                                    {% else %}
                                        <i class="fas fa-clock text-warning ms-1" title="Chờ xác minh"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if member %}
                                        <strong>{{ member.full_name }}</strong><br>
                                        <small class="text-muted">
                                            ID: {{ member.id }} - 
                                            {% if member.role == 'giaovien' %}
                                                <span class="badge bg-success">Giáo viên</span>
                                            {% else %}
                                                <span class="badge bg-info">Phụ huynh</span>
                                            {% endif %}
                                        </small><br>
                                        <small class="text-muted">{{ member.phone }}</small>
                                    {% else %}
                                        <span class="text-muted">Unknown (ID: {{ student.added_by }})</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        {{ student.created_at.strftime('%d/%m/%Y') }}<br>
                                        <span class="text-muted">{{ student.created_at.strftime('%H:%M') }}</span>
                                    </small>
                                </td>
                                <td>
                                    {% if student.confirmed %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Đã xác minh
                                        </span>
                                        {% if student.confirmed_by %}
                                            <br><small class="text-muted">Bởi: {{ student.confirmed_by }}</small>
                                        {% endif %}
                                    {% elif student.status == 'rejected' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> Đã từ chối
                                        </span>
                                        {% if student.confirmed_by %}
                                            <br><small class="text-muted">Bởi: {{ student.confirmed_by }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock"></i> Chờ xác minh
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if student.notes %}
                                        <span class="text-muted" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-placement="top" 
                                              title="{{ student.notes }}">
                                            {{ student.notes[:30] }}{% if student.notes|length > 30 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not student.confirmed and student.status == 'pending' %}
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('confirm_student', student_id=student.id) }}" 
                                               class="btn btn-success btn-sm"
                                               onclick="return confirm('Xác minh học sinh {{ student.name }}?')">
                                                <i class="fas fa-check"></i> Xác minh
                                            </a>
                                            <a href="{{ url_for('reject_student', student_id=student.id) }}" 
                                               class="btn btn-danger btn-sm"
                                               onclick="return confirm('Từ chối học sinh {{ student.name }}?')">
                                                <i class="fas fa-times"></i> Từ chối
                                            </a>
                                        </div>
                                    {% else %}
                                        <small class="text-muted">Đã xử lý</small>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="text-muted">
                Hiển thị {{ students | length }} học sinh
                {% if status_filter != 'all' %}
                    - <a href="{{ url_for('admin_students', status='all') }}">Xem tất cả</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bulk Actions for Pending Students -->
    {% set pending_students = students | rejectattr('confirmed') | selectattr('status', 'equalto', 'pending') | list %}
    {% if pending_students and status_filter == 'pending' %}
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6><i class="fas fa-bolt"></i> Thao tác hàng loạt</h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Có {{ pending_students | length }} học sinh chờ xác minh. 
                    Hãy xem xét từng trường hợp cẩn thận để đảm bảo tính chính xác.
                </p>
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Lưu ý quan trọng:</h6>
                    <ul class="mb-0">
                        <li>Chỉ xác minh khi học sinh <strong>thực sự đã nhập học</strong></li>
                        <li>Kiểm tra thông tin với giáo vụ trước khi xác minh</li>
                        <li>Xác minh sẽ <strong>tự động cộng thưởng</strong> vào ví người giới thiệu</li>
                        <li>Không thể hoàn tác sau khi xác minh</li>
                    </ul>
                </div>
            </div>
        </div>
    {% endif %}

{% else %}
    <!-- Empty State -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-graduation-cap fa-4x text-muted mb-4"></i>
            <h4 class="text-muted">
                {% if status_filter == 'pending' %}
                    Không có học sinh nào chờ xác minh
                {% elif status_filter == 'confirmed' %}
                    Chưa có học sinh nào được xác minh
                {% else %}
                    Chưa có học sinh nào trong hệ thống
                {% endif %}
            </h4>
            <p class="text-muted">
                {% if status_filter == 'pending' %}
                    Tất cả học sinh đều đã được xử lý.
                {% else %}
                    Hệ thống sẽ hiển thị học sinh khi có thành viên thêm vào.
                {% endif %}
            </p>
            {% if status_filter != 'all' %}
                <a href="{{ url_for('admin_students', status='all') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i> Xem tất cả học sinh
                </a>
            {% endif %}
        </div>
    </div>
{% endif %}

<!-- Help Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6><i class="fas fa-question-circle"></i> Quy trình xác minh</h6>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>Thành viên thêm thông tin học sinh</li>
                    <li>Admin kiểm tra với giáo vụ</li>
                    <li>Xác nhận học sinh đã nhập học thực tế</li>
                    <li>Nhấn "Xác minh" để cộng thưởng tự động</li>
                </ol>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6><i class="fas fa-gift"></i> Thưởng tự động</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Giáo viên:</strong> 2,000,000 VND + bonus mỗi 5 HS</li>
                    <li><strong>Phụ huynh:</strong> 2,000 điểm + bonus mỗi 5 HS</li>
                    <li>Thưởng được ghi vào ví và lịch sử ngay lập tức</li>
                    <li>Thông báo tự động cho thành viên</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Auto refresh every minute for pending students
setInterval(function() {
    if ('{{ status_filter }}' === 'pending') {
        console.log('Checking for new students...');
        // Could implement AJAX update here
    }
}, 60000);

// Confirmation dialogs with more details
function confirmStudent(studentId, studentName, memberName) {
    return confirm(`Xác minh học sinh "${studentName}" do ${memberName} giới thiệu?\n\nLưu ý: Thao tác này sẽ:\n- Cộng thưởng vào ví người giới thiệu\n- Không thể hoàn tác\n- Cập nhật lịch sử giao dịch`);
}

function rejectStudent(studentId, studentName) {
    return confirm(`Từ chối học sinh "${studentName}"?\n\nLưu ý: Học sinh sẽ được đánh dấu "Đã từ chối" và không được tính thưởng.`);
}
</script>
{% endblock %}