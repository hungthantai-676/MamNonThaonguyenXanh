Má»¥c tiÃªu pháº§n 4
Cho phÃ©p thÃ nh viÃªn yÃªu cáº§u rÃºt tiá»n

Admin duyá»‡t/ tá»« chá»‘i yÃªu cáº§u rÃºt

Khi duyá»‡t, sá»‘ tiá»n tá»± Ä‘á»™ng trá»« trong vÃ­ vÃ  ghi lá»‹ch sá»­ giao dá»‹ch

Quáº£n trá»‹ phÃ¢n quyá»n rÃµ:

admin cÃ³ thá»ƒ xem vÃ  xá»­ lÃ½ má»i thá»©

member chá»‰ xem vÃ­ cá»§a mÃ¬nh

ğŸ§± Cáº­p nháº­t Database
âœ… Táº¡o báº£ng yÃªu cáº§u rÃºt tiá»n:
python
Sao chÃ©p
Chá»‰nh sá»­a
class WithdrawalRequest(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    member_id = db.Column(db.Integer, db.ForeignKey('member.id'), nullable=False)
    amount = db.Column(db.Integer, nullable=False)
    status = db.Column(db.String(20), default='pending')  # pending | approved | rejected
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
ğŸ“„ Route thÃ nh viÃªn táº¡o yÃªu cáº§u rÃºt tiá»n
python
Sao chÃ©p
Chá»‰nh sá»­a
@app.route('/withdraw/<int:member_id>', methods=['GET', 'POST'])
def withdraw(member_id):
    member = Member.query.get(member_id)
    wallet = member.wallet
    if request.method == 'POST':
        amount = int(request.form['amount'])
        if amount <= 0 or amount > wallet.balance:
            return "âŒ Sá»‘ tiá»n khÃ´ng há»£p lá»‡!"

        req = WithdrawalRequest(member_id=member.id, amount=amount)
        db.session.add(req)
        db.session.commit()
        return "âœ… ÄÃ£ gá»­i yÃªu cáº§u rÃºt tiá»n, chá» admin duyá»‡t!"
    
    return render_template('withdraw.html', member=member, wallet=wallet)
ğŸ“„ Giao diá»‡n withdraw.html
html
Sao chÃ©p
Chá»‰nh sá»­a
<h2>ğŸ“¤ YÃªu cáº§u rÃºt tiá»n</h2>
<p>Sá»‘ dÆ° hiá»‡n táº¡i: {{ wallet.balance }} VND</p>
<form method="POST">
  <input name="amount" type="number" placeholder="Sá»‘ tiá»n muá»‘n rÃºt" required>
  <button type="submit">Gá»­i yÃªu cáº§u</button>
</form>
ğŸ“„ Admin duyá»‡t yÃªu cáº§u
python
Sao chÃ©p
Chá»‰nh sá»­a
@app.route('/admin/withdrawals')
def admin_withdrawals():
    requests = WithdrawalRequest.query.filter_by(status='pending').all()
    return render_template('admin_withdrawals.html', requests=requests)

@app.route('/admin/approve/<int:req_id>')
def approve_request(req_id):
    req = WithdrawalRequest.query.get(req_id)
    if req and req.status == 'pending':
        wallet = Wallet.query.filter_by(member_id=req.member_id).first()
        if wallet.balance >= req.amount:
            wallet.balance -= req.amount
            wallet.history += f"{datetime.now().strftime('%d/%m/%Y')} - RÃºt tiá»n -{req.amount} VND\n"
            req.status = 'approved'
            db.session.commit()
            return "âœ… ÄÃ£ duyá»‡t vÃ  trá»« tiá»n trong vÃ­"
        else:
            return "âŒ Sá»‘ dÆ° khÃ´ng Ä‘á»§"
    return "âŒ YÃªu cáº§u khÃ´ng há»£p lá»‡"
ğŸ“„ admin_withdrawals.html
html
Sao chÃ©p
Chá»‰nh sá»­a
<h2>ğŸ“¥ Danh sÃ¡ch yÃªu cáº§u rÃºt tiá»n</h2>
<ul>
  {% for r in requests %}
    <li>ThÃ nh viÃªn: {{ r.member_id }} | Sá»‘ tiá»n: {{ r.amount }} VND
      - <a href="/admin/approve/{{ r.id }}">âœ… Duyá»‡t</a>
    </li>
  {% endfor %}
</ul>
âœ… Quáº£n lÃ½ phÃ¢n quyá»n
CÃ¡ch Ä‘Æ¡n giáº£n trÆ°á»›c máº¯t:
Giao diá»‡n admin chá»‰ cÃ³ link riÃªng /admin/* khÃ´ng ai biáº¿t.

Sau nÃ y cÃ³ thá»ƒ tÃ­ch há»£p Flask-Login + role='admin' Ä‘á»ƒ kiá»ƒm soÃ¡t session tá»‘t hÆ¡n.

âœ… Kiá»ƒm soÃ¡t log & minh báº¡ch
Má»i láº§n rÃºt tiá»n Ä‘á»u Ä‘Æ°á»£c lÆ°u vÃ o báº£ng WithdrawalRequest

VÃ­ ghi láº¡i lá»‹ch sá»­ giao dá»‹ch rÃµ rÃ ng

Admin kiá»ƒm tra Ä‘Æ°á»£c tá»«ng giao dá»‹ch

ğŸ¯ Káº¿t quáº£ sau pháº§n 4:
 ThÃ nh viÃªn cÃ³ thá»ƒ yÃªu cáº§u rÃºt tiá»n

 Admin duyá»‡t, trá»« vÃ­

 LÆ°u log giao dá»‹ch minh báº¡ch

 Quáº£n trá»‹ dá»…, cÃ³ thá»ƒ má»Ÿ rá»™ng phÃ¢n quyá»n máº¡nh hÆ¡n

